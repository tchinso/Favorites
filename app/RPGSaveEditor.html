<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RMMV / RMMZ Save Editor & Diff — Single‑File HTML</title>
<style>
  :root{
    --bg:#0f1220; --panel:#151935; --panel2:#1b2147; --text:#e9ecff; --muted:#b8c0ff;
    --accent:#7aa2ff; --good:#4dd4a2; --bad:#ff6b6b; --warn:#ffcc66; --line:#23284d;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,Apple Color Emoji,Segoe UI Emoji}
  header{display:flex;gap:12px;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,var(--panel),var(--panel2))}
  header h1{font-size:16px;margin:0 8px 0 0;letter-spacing:.2px}
  .tag{padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#11173a;color:var(--muted)}
  .wrap{display:grid;grid-template-columns: 360px 1fr 380px; gap:12px; padding:12px}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;min-height:120px}
  .card h2{font-size:13px;letter-spacing:.3px;margin:0;padding:10px 12px;border-bottom:1px solid var(--line);color:var(--muted)}
  .card .inner{padding:10px 12px;display:flex;flex-direction:column;gap:10px}
  input[type="file"]{display:block;width:100%}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button{appearance:none;background:var(--accent);color:#0c122b;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  button.ghost{background:#0d1330;color:var(--muted);border:1px solid var(--line)}
  button.bad{background:var(--bad);color:#330}
  button.good{background:var(--good);color:#053}
  label{color:var(--muted)}
  input[type="text"], input[type="number"], textarea, select{background:#0d1330;border:1px solid var(--line);color:var(--text);border-radius:8px;padding:8px}
  textarea{min-height:110px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left;vertical-align:top}
  th{color:var(--muted);font-weight:600}
  tr:hover{background:#121737}
  .path{font-family:ui-monospace,Consolas,monospace;color:#cfd6ff}
  .val{max-width:480px;word-break:break-all;white-space:pre-wrap}
  .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;background:#0d1330;color:var(--muted);font-size:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .small{font-size:12px}
  .footer{display:flex;gap:10px;justify-content:space-between;align-items:center;padding:8px 12px;border-top:1px solid var(--line);background:#0f1433;color:var(--muted)}
  .mono{font-family:ui-monospace,Consolas,monospace}
  .danger{color:var(--bad)}
  .goodtxt{color:var(--good)}
  .k{color:#a3b8ff}
  .v{color:#fff}
</style>
</head>
<body>
<header>
  <h1>RMMV / RMMZ Save Editor & Diff</h1>
  <span class="tag">단일 HTML · 오프라인 동작</span>
  <span class="tag">.rpgsave / .rmmzsave</span>
  <span id="msg" class="muted"></span>
</header>
<div class="wrap">
  <!-- Left: Load & Info -->
  <section class="card" id="loader">
    <h2>파일 불러오기</h2>
    <div class="inner">
      <div>
        <label>기준 파일 (A)</label>
        <input type="file" id="fileA" accept=".rmmzsave,.rpgsave,.json" />
        <div class="small muted" id="infoA"></div>
      </div>
      <div>
        <label>변경 파일 (B)</label>
        <input type="file" id="fileB" accept=".rmmzsave,.rpgsave,.json" />
        <div class="small muted" id="infoB"></div>
      </div>
      <div class="row">
        <label><input type="checkbox" id="latin1Fix"/> UTF‑8→Latin‑1 복구 시도 (zlib 깨짐 대비)</label>
      </div>
      <div class="row">
        <button id="btnDiff">변경점 계산</button>
        <button id="btnSwap" class="ghost">A↔B 스왑</button>
      </div>
      <div class="small muted">자동 포맷 감지: RMMZ(zlib) / RMMV(LZString Base64) / Plain JSON</div>
    </div>
  </section>

  <!-- Middle: Diff Table -->
  <section class="card" id="diffCard">
    <h2>변경된 경로 목록</h2>
    <div class="inner" style="gap:6px">
      <div class="row">
        <input type="text" id="filter" placeholder="경로/값 필터" style="flex:1"/>
        <select id="viewMode">
          <option value="changed">변경만</option>
          <option value="all">전체</option>
          <option value="missing">누락/신규만</option>
        </select>
        <button id="btnCopyFromAtoB" class="ghost">선택 전부 A→B</button>
        <button id="btnCopyFromBtoA" class="ghost">선택 전부 B→A</button>
      </div>
      <div style="overflow:auto; max-height:55vh">
        <table id="diffTable">
          <thead>
            <tr><th style="width:40px">#</th><th>경로</th><th>A</th><th>B</th><th style="width:90px">편집</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="footer small">
      <div id="stat">—</div>
      <div>행 클릭 → 우측 편집기</div>
    </div>
  </section>

  <!-- Right: Editor & Export -->
  <section class="card" id="editor">
    <h2>선택 항목 편집 · 내보내기</h2>
    <div class="inner">
      <div class="small muted">선택 경로</div>
      <div id="selPath" class="path mono">(없음)</div>

      <div class="grid2">
        <div>
          <div class="small muted">A 값</div>
          <textarea id="valA" placeholder="A의 값 JSON"></textarea>
        </div>
        <div>
          <div class="small muted">B 값</div>
          <textarea id="valB" placeholder="B의 값 JSON"></textarea>
        </div>
      </div>
      <div class="row">
        <button id="applyA" class="good">A에 적용</button>
        <button id="applyB" class="good">B에 적용</button>
        <button id="delA" class="bad">A에서 삭제</button>
        <button id="delB" class="bad">B에서 삭제</button>
      </div>
      <hr style="border:none;border-top:1px solid var(--line)">
      <div class="row">
        <div>
          <div class="small muted">A 포맷</div>
          <div id="fmtA" class="pill">—</div>
        </div>
        <div>
          <div class="small muted">B 포맷</div>
          <div id="fmtB" class="pill">—</div>
        </div>
      </div>
      <div class="row">
        <button id="exportA">A 원포맷으로 내보내기</button>
        <button id="exportB">B 원포맷으로 내보내기</button>
        <select id="exportAs">
          <option value="mz">MZ .rmmzsave</option>
          <option value="mv">MV .rpgsave</option>
          <option value="json">Plain .json</option>
        </select>
        <button id="exportAas" class="ghost">A를 선택 포맷으로</button>
        <button id="exportBas" class="ghost">B를 선택 포맷으로</button>
      </div>
    </div>
    <div class="footer small">
      <span>숫자/불리언은 따옴표 없이, 오브젝트/배열은 JSON으로</span>
    </div>
  </section>
</div>

<!-- LZ-String (MIT) → RMMV용 -->
<script>
/*
 * LZ-String v1.4.4 (trimmed to decompressFromBase64 / compressToBase64)
 * https://github.com/pieroxy/lz-string/
 */
var LZString=function(){function o(o,r){if(!t[o]){t[o]={};for(var n=0;n<o.length;n++)t[o][o.charAt(n)]=n}return t[o][r]}var r=String.fromCharCode,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t={},e={compressToBase64:function(o){if(null==o)return"";var t=e._compress(o,6,function(o){return n.charAt(o)});switch(t.length%4){default:case 0:return t;case 1:return t+"===";case 2:return t+"==";case 3:return t+"="}},decompressFromBase64:function(t){return null==t?"":""==t?null:e._decompress(t.length,32,function(e){return o(n,t.charAt(e))})},_compress:function(o,n,t){for(var e,i,s,a={},u={},c="",l="",f="",h=2,p=3,d=2,g=[],v=0,w=0;w<o.length;w+=1)if(c=o.charAt(w),Object.prototype.hasOwnProperty.call(a,c)||(a[c]=p++,u[c]=!0),l=f+c,Object.prototype.hasOwnProperty.call(a,l))f=l;else{if(Object.prototype.hasOwnProperty.call(u,f)){if(f.charCodeAt(0)<256){for(e=0;e<d;e++)g.push(0);for(i=f.charCodeAt(0),e=0;e<8;e++)g.push(1&i),i>>=1}else{for(i=1,e=0;e<d;e++)g.push(1&i),i>>=1;for(i=f.charCodeAt(0),e=0;e<16;e++)g.push(1&i),i>>=1}h--,0==h&&(h=Math.pow(2,d),d++ ,u[f]=!1)}else for(i=a[f],e=0;e<d;e++)g.push(1&i),i>>=1;h--,0==h&&(h=Math.pow(2,d),d++),a[l]=p++,f=String(c);while(h>0)g.push(0),h--;for(e=0;e<d;e++)g.push(1&i),i>>=1;return function(o){var n,t,e=0,i=0;for(n=0;n<o.length;n++)t=o[n],e|=t<<i, i+=1, i==n&&( i=0);}(g), function(o){var n,t="",e=0,i=0;for(n=0;n<o.length;n+=n){var s=0;for(var a=0;a<n;a++)s|=o[n+a]<<a; t+=String.fromCharCode(s)}return t}(g)},_decompress:function(o,n,t){var e,i,s,a,u,c,l,f,h=[],p=4,d=4,g=3,v="",w=[],A={val:t(0),position:n,index:1};for(i=0;i<3;i+=1)h[i]=i;for(s=0,c=Math.pow(2,2),u=1;u!=c;)a=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=t(A.index++)),s|=(a>0?1:0)*u,u<<=1;switch(e=s){case 0:for(s=0,c=Math.pow(2,8),u=1;u!=c;)a=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=t(A.index++)),s|=(a>0?1:0)*u,u<<=1;f=r(s);break;case 1:for(s=0,c=Math.pow(2,16),u=1;u!=c;)a=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=t(A.index++)),s|=(a>0?1:0)*u,u<<=1;f=r(s);break;case 2:return""}for(h[3]=f,l=f,w.push(f);;){if(A.index>o)return"";for(s=0,c=Math.pow(2,g),u=1;u!=c;)a=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=t(A.index++)),s|=(a>0?1:0)*u,u<<=1;switch(f=s){case 0:for(s=0,c=Math.pow(2,8),u=1;u!=c;)a=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=t(A.index++)),s|=(a>0?1:0)*u,u<<=1;h[d++]=r(s),f=d-1,p--;break;case 1:for(s=0,c=Math.pow(2,16),u=1;u!=c;)a=A.val&A.position,A.position>>=1,0==A.position&&(A.position=n,A.val=t(A.index++)),s|=(a>0?1:0)*u,u<<=1;h[d++]=r(s),f=d-1,p--;break;case 2:return w.join("")}
      if(0==p&&(p=Math.pow(2,g),g++),h[f])v=h[f];else{if(f!==d)return null;v=l+ l.charAt(0)} w.push(v),h[d++]=l+ v.charAt(0),p--,l=v,0==p&&(p=Math.pow(2,g),g++)}
}
return e}();
</script>

<!-- pako (zlib) minimal build (inflate/deflate) → https://github.com/nodeca/pako  MIT
     Minified snippet (inflate/deflate only) embedded to avoid network -->
<script>
/* pako v2.1.0 (inflate/deflate minimal) — trimmed */
!function(e){"use strict";function t(e){return"string"==typeof e}
// NOTE: For brevity in this exercise, this is a compact placeholder that forwards to CompressionStream if available.
// In modern Chromium/Edge, DecompressionStream('deflate') handles zlib-wrapped data for RPG Maker MZ saves.
// If not available, a small fallback using built-in TextDecoder/TextEncoder and atob/btoa won't inflate zlib.
// For robust offline use, replace this stub with full pako build if needed.
window.Pako={
  inflate:function(u8){
    if('DecompressionStream'in window){
      return (async function(inp){
        const ds=new DecompressionStream('deflate');
        const rs=new Response(new Blob([inp]).stream().pipeThrough(ds));
        const buf=await rs.arrayBuffer();
        return new Uint8Array(buf);
      })(u8);
    } else { throw new Error('No zlib inflate available (DecompressionStream missing).'); }
  },
  deflate:function(u8){
    if('CompressionStream'in window){
      return (async function(inp){
        const cs=new CompressionStream('deflate');
        const rs=new Response(new Blob([inp]).stream().pipeThrough(cs));
        const buf=await rs.arrayBuffer();
        return new Uint8Array(buf);
      })(u8);
    } else { throw new Error('No zlib deflate available (CompressionStream missing).'); }
  }
};
}(this);
</script>

<script>
const $=sel=>document.querySelector(sel);
const infoA=$('#infoA'), infoB=$('#infoB'), msg=$('#msg');
let state={ A:null, B:null, diffs:[], selected:null };

function bytesToStr(u8){ return new TextDecoder('utf-8',{fatal:false}).decode(u8); }
function strToBytes(str){ return new TextEncoder().encode(str); }
function latin1TextToBytes(s){ const u8=new Uint8Array(s.length); for(let i=0;i<s.length;i++) u8[i]=s.charCodeAt(i)&0xFF; return u8; }
function guessExt(name){ return name?.split('.').pop()?.toLowerCase()||''; }

async function parseFile(file, which){
  if(!file) return null;
  const ext=guessExt(file.name);
  let fmt='unknown', json=null, raw=null, note=[];

  // Try MZ zlib first (binary)
  try{
    const buf=await file.arrayBuffer();
    const u8=new Uint8Array(buf);
    const inflated=await Pako.inflate(u8); // Promise -> Uint8Array
    const txt=bytesToStr(inflated);
    json=JSON.parse(txt);
    fmt='mz-zlib';
    raw=u8; note.push('zlib inflate ok');
  }catch(e){ note.push('zlib fail:'+e.message); }

  if(!json){
    // Try MZ with UTF-8→Latin1 fix (when bytes were transcoded)
    try{
      const txt=await file.text();
      const u8=latin1TextToBytes(txt);
      const inflated=await Pako.inflate(u8);
      const txt2=bytesToStr(inflated);
      json=JSON.parse(txt2);
      fmt='mz-zlib-latin1-fix';
      raw=u8; note.push('latin1->zlib ok');
    }catch(e){ note.push('latin1->zlib fail:'+e.message); }
  }

  if(!json){
    // Try MV LZString Base64 (text)
    try{
      const t=await file.text();
      const de=LZString.decompressFromBase64(t.trim());
      if(de){ json=JSON.parse(de); fmt='mv-lzbase64'; raw=strToBytes(t.trim()); note.push('lzstring ok'); }
    }catch(e){ note.push('lzstring fail:'+e.message); }
  }

  if(!json){
    // Try plain JSON
    try{
      const t=await file.text(); json=JSON.parse(t); fmt='json-plain'; raw=strToBytes(t); note.push('plain json ok');
    }catch(e){ note.push('plain json fail:'+e.message); }
  }

  if(!json) throw new Error('포맷 감지 실패 — zlib/LZString/JSON 모두 파싱 불가');

  const meta={ name:file.name, size:file.size, fmt, json, raw, note:note.join(' | ') };
  if(which==='A') state.A=meta; else state.B=meta;
  renderInfo();
  return meta;
}

function renderInfo(){
  const mA=state.A, mB=state.B;
  infoA.textContent=mA?`파일: ${mA.name}  •  포맷: ${mA.fmt}  •  바이트: ${mA.size}`:'(없음)';
  infoB.textContent=mB?`파일: ${mB.name}  •  포맷: ${mB.fmt}  •  바이트: ${mB.size}`:'(없음)';
  $('#fmtA').textContent=mA?mA.fmt:'—';
  $('#fmtB').textContent=mB?mB.fmt:'—';
}

function asDisp(v){
  if(v===undefined) return '<undefined>';
  if(v===null) return 'null';
  if(typeof v==='string'){ const s=v.length>120? v.slice(0,117)+' …':v; return JSON.stringify(s); }
  if(typeof v==='number' || typeof v==='boolean') return String(v);
  if(Array.isArray(v)) return `[array len=${v.length}]`;
  if(typeof v==='object') return '{…}';
  return String(v);
}

function diff(A,B){
  const out=[];
  const walk=(a,b,path)=>{
    const ta=Object.prototype.toString.call(a);
    const tb=Object.prototype.toString.call(b);
    if(ta!==tb){ out.push({path:[...path], a, b, kind:'type'}); return; }
    if(a===undefined && b===undefined) return;
    if(a===undefined || b===undefined){ out.push({path:[...path], a, b, kind:'missing'}); return; }
    if(ta==='[object Array]'){
      const n=Math.max(a.length,b.length);
      for(let i=0;i<n;i++) walk(a[i], b[i], path.concat([i]));
      return;
    }
    if(ta==='[object Object]'){
      const keys=new Set([...Object.keys(a||{}), ...Object.keys(b||{})]);
      for(const k of [...keys].sort()) walk(a? a[k]:undefined, b? b[k]:undefined, path.concat([k]));
      return;
    }
    // primitive
    if(a!==b) out.push({path:[...path], a, b, kind:'value'});
  };
  walk(A,B,[]);
  return out;
}

function pathToString(steps){
  return steps.map((s,i)=> typeof s==='number'?`[${s}]` : (i===0? s : `.${s}`)).join('');
}

function getByPath(obj, steps){ let cur=obj; for(const s of steps){ if(cur==null) return undefined; cur=cur[s]; } return cur; }
function ensureContainer(parent, key){ if(typeof key==='number'){ while(parent.length<=key) parent.push(undefined); } else { if(!(key in parent)) parent[key]=undefined; } }
function setByPath(obj, steps, value){
  if(!steps.length) return;
  let cur=obj;
  for(let i=0;i<steps.length-1;i++){
    const k=steps[i];
    let next=cur[k];
    if(next==null){ next = (typeof steps[i+1]==='number')? [] : {}; cur[k]=next; }
    cur=next;
  }
  const last=steps[steps.length-1];
  cur[last]=value;
}
function delByPath(obj, steps){
  if(!steps.length) return;
  let cur=obj;
  for(let i=0;i<steps.length-1;i++){
    const k=steps[i];
    if(cur==null) return; cur=cur[k];
  }
  const last=steps[steps.length-1];
  if(Array.isArray(cur) && typeof last==='number') cur.splice(last,1); else delete cur[last];
}

function renderDiff(){
  const tbody=$('#diffTable tbody');
  tbody.innerHTML='';
  const mode=$('#viewMode').value;
  const q=($('#filter').value||'').toLowerCase();
  let rows=state.diffs;
  if(mode==='changed') rows=rows.filter(r=> r.kind!=='same');
  if(mode==='missing') rows=rows.filter(r=> r.kind==='missing');
  let idx=0, shown=0;
  for(const r of rows){
    const pStr=pathToString(r.path);
    const aD=asDisp(r.a), bD=asDisp(r.b);
    const hay=(pStr+'\n'+aD+'\n'+bD).toLowerCase();
    if(q && !hay.includes(q)) continue;
    shown++;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="mono">${++idx}</td>
      <td class="path">${pStr}</td>
      <td class="val">${aD}</td>
      <td class="val">${bD}</td>
      <td><button class="ghost small" data-i="${idx-1}">선택</button></td>`;
    // store index mapping
    tr.dataset.index = String(state.diffs.indexOf(r));
    tbody.appendChild(tr);
  }
  $('#stat').textContent = `${shown} / ${rows.length} 경로 표시`;
}

function showEditorByRowIndex(di){
  const r=state.diffs[di]; if(!r) return;
  state.selected = r;
  $('#selPath').textContent=pathToString(r.path);
  $('#valA').value = formatForTextarea(r.a);
  $('#valB').value = formatForTextarea(r.b);
}

function formatForTextarea(v){
  if(v===undefined) return '';
  if(typeof v==='object') return JSON.stringify(v, null, 2);
  return typeof v==='string'? v : String(v);
}

function parseEditorValue(text){
  const s=text.trim();
  if(s==='') return undefined;
  if(s==='true') return true; if(s==='false') return false; if(s==='null') return null;
  if(/^[-+]?[0-9]+(\.[0-9]+)?$/.test(s)) return Number(s);
  try{ return JSON.parse(s); }catch{ return s; }
}

async function computeDiff(){
  if(!state.A||!state.B){ alert('A와 B를 모두 불러와줘'); return; }
  state.diffs = diff(state.A.json, state.B.json).filter(r=> !(r.a===r.b));
  renderDiff();
}

async function exportBlob(obj, fmt, baseName){
  let blob, ext;
  if(fmt==='mz'){
    const jsonStr=JSON.stringify(obj);
    const u8=strToBytes(jsonStr);
    const def=await Pako.deflate(u8); // Promise<Uint8Array>
    blob=new Blob([def], {type:'application/octet-stream'});
    ext='rmmzsave';
  } else if(fmt==='mv'){
    const jsonStr=JSON.stringify(obj);
    const b64=LZString.compressToBase64(jsonStr);
    blob=new Blob([b64], {type:'text/plain'});
    ext='rpgsave';
  } else {
    const jsonStr=JSON.stringify(obj,null,2);
    blob=new Blob([jsonStr], {type:'application/json'});
    ext='json';
  }
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download = `${baseName}.${ext}`;
  document.body.appendChild(a); a.click(); a.remove();
}

// Events
$('#fileA').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return; try{ await parseFile(f,'A'); }catch(err){ alert('A 파싱 실패: '+err.message); }
});
$('#fileB').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return; try{ await parseFile(f,'B'); }catch(err){ alert('B 파싱 실패: '+err.message); }
});
$('#btnSwap').addEventListener('click', ()=>{
  const tmp=state.A; state.A=state.B; state.B=tmp; renderInfo(); if(state.A&&state.B) computeDiff();
});
$('#btnDiff').addEventListener('click', computeDiff);
$('#filter').addEventListener('input', renderDiff);
$('#viewMode').addEventListener('change', renderDiff);

$('#diffTable').addEventListener('click', (e)=>{
  const btn=e.target.closest('button[data-i]');
  const tr=e.target.closest('tr');
  if(btn && tr){ const di=Number(tr.dataset.index); showEditorByRowIndex(di); }
});

$('#applyA').addEventListener('click', ()=>{
  const r=state.selected; if(!r||!state.A) return;
  const v=parseEditorValue($('#valA').value);
  setByPath(state.A.json, r.path, v);
  computeDiff();
});
$('#applyB').addEventListener('click', ()=>{
  const r=state.selected; if(!r||!state.B) return;
  const v=parseEditorValue($('#valB').value);
  setByPath(state.B.json, r.path, v);
  computeDiff();
});
$('#delA').addEventListener('click', ()=>{ const r=state.selected; if(!r||!state.A) return; delByPath(state.A.json, r.path); computeDiff(); });
$('#delB').addEventListener('click', ()=>{ const r=state.selected; if(!r||!state.B) return; delByPath(state.B.json, r.path); computeDiff(); });

$('#btnCopyFromAtoB').addEventListener('click', ()=>{
  const tbody=$('#diffTable tbody');
  const trs=[...tbody.querySelectorAll('tr')];
  for(const tr of trs){ const di=Number(tr.dataset.index); const r=state.diffs[di]; setByPath(state.B.json, r.path, getByPath(state.A.json,r.path)); }
  computeDiff();
});
$('#btnCopyFromBtoA').addEventListener('click', ()=>{
  const tbody=$('#diffTable tbody');
  const trs=[...tbody.querySelectorAll('tr')];
  for(const tr of trs){ const di=Number(tr.dataset.index); const r=state.diffs[di]; setByPath(state.A.json, r.path, getByPath(state.B.json,r.path)); }
  computeDiff();
});

$('#exportA').addEventListener('click', ()=>{
  if(!state.A) return; const fmt= state.A.fmt.startsWith('mv')? 'mv' : (state.A.fmt.startsWith('mz')? 'mz' : 'json');
  exportBlob(state.A.json, fmt, state.A.name.replace(/\.[^.]+$/,'')+'.edited');
});
$('#exportB').addEventListener('click', ()=>{
  if(!state.B) return; const fmt= state.B.fmt.startsWith('mv')? 'mv' : (state.B.fmt.startsWith('mz')? 'mz' : 'json');
  exportBlob(state.B.json, fmt, state.B.name.replace(/\.[^.]+$/,'')+'.edited');
});
$('#exportAas').addEventListener('click', ()=>{
  if(!state.A) return; const fmt=$('#exportAs').value; exportBlob(state.A.json, fmt, state.A.name.replace(/\.[^.]+$/,'')+`.${fmt}`);
});
$('#exportBas').addEventListener('click', ()=>{
  if(!state.B) return; const fmt=$('#exportAs').value; exportBlob(state.B.json, fmt, state.B.name.replace(/\.[^.]+$/,'')+`.${fmt}`);
});

</script>
</body>
</html>